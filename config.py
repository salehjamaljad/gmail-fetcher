barcode_to_product = {
            "2283957660118": "ملوخية جاهزة500جم",
            "2283957710019": "فاصوليا مقطعة فريش 350 جرام",
            "2283957660106": "كابوتشا مقطع 350 جم",
            "2283957660097": "ميكس كرنب سلطة مقطع فريش 350 جرام",
            "2283957660093": "بطاطس شيبسى فريش 350 جرام",
            "2283957660091": "بطاطس صوابع فريش 350 جرام",
            "2283957660101": "فلفل مقور محشي 350 جم",
            "2283957660105": "بطاطس شرائح 350 جم",
            "2283957660104": "جزر مقطع 350 جم",
            "2283957660103": "كوسة حلقات 350جم",
            "2283957980016": "فلفل حلو 250 جرام",
            "2283957660070": "رمان 1كجم",
            "2283958160045": "ابوفروة 250جم",
            "2283957660068": "يوسفي كلمنتينا 1كجم",
            "2283958160042": "يوسفي بلدي 1كجم",
            "2283958160092": "بلح برحي 500 جم",
            "2283958160132": "خوخ مستورد 500 جم",
            "2283958160095": "نكتارين مستورد 500 جم",
            "2283957880019": "فلفل اخضر كوبي 250جم",
            "2283958160018": "ثوم صيني ابيض 200جم",
            "2283958160038": "فول سوداني 500جم",
            "2283957680015": "رمان مفرط 350 جم",
            "2283957750015": "بامية جاهزة 350 جم",
            "2283958130014": "ملوخية جاهزة350جم",
            "2283958160072": "كريز 250 جم",
            "2283958160084": "مانجو فونس 1 ك",
            "2283958160083": "مانجو فص عويس 500 جم",
            "2283958160073": "مانجو عويس 1 ك",
            "2283958160066": "مانجو صديقة 1ك",
            "2283958160063": "مانجو زبدية 1ك",
            "2283958160054": "برقوق احمر محلي 1ك",
            "2283958160082": "عنب بناتى 1ك",
            "2283958160051": "عنب ايرلي سويت ابيض 1ك",
            "2283958160050": "عنب فليم احمر 1ك",
            "2283958160070": "قصب مقشر350جم",
            "2283958090011": "قلقاس مكعبات فريش 350 جرام",
            "2283958070013": "محشى مشكل فريش 350 جرام",
            "2283958050015": "كوسة مقورة فريش 350 جرام",
            "2283957740022": "كمثرى افريقي500 جرام",
            "2283957910013": "فلفل الوان معبأ 500 جرام",
            "2283957690014": "تفاح اصفر ايطالى 1ك معبأ",
            "2283957740020": "برتقال عصير 2ك معبأ",
            "2283958160057": "جوز هند قطعة",
            "2283958160043": "يوسفي موركت 1ك",
            "2283958160031": "جوافة 1ك معبأ",
            "2283957600013": "بطاطا 1ك",
            "2283957550011": "برتقال بسرة 1ك",
            "2283957580018": "بطاطس معبأ 1ك",
            "2283957540012": "بصل احمر معبأ 1ك",
            "2283958040016": "بصل ابيض معبأ 1ك",
            "2283957990015": "باذنجان كوبى معبأ 1ك",
            "2283958160055": "عنب كريمسون لبنانى 500 جرام معبأ",
            "2283958160060": "قرع مكعبات صافى 350 جرام",
            "2283957770013": "عبوة ثوم مفصص 100 جرام",
            "2283957830014": "خضار مشكل فريش 350 جرام",
            "2283957800017": "سوتيه فريش 350 جرام",
            "2283957650018": "بسلة مفصصة بالجزر فريش 350 جرام",
            "2283957590017": "بسلة مفصصة فريش 350 جرام",
            "2283957740016": "عنب اسود مستورد 500 جرام معبأ",
            "2283957920012": "موز مستورد 1ك",
            "2283957870010": "كيوي فاخر 250 جرام معبأ",
            "2283957660017": "تفاح اخضر امريكى 1ك معبأ",
            "2283957720018": "تفاح سكرى جالا 1ك معبأ",
            "2283957640019": "تفاح احمر مستورد 1ك معبأ",
            "2283957570019": "برقوق احمر مستورد 1ك",
            "2283958160046": "اناناس سكري فاخر معبأ",
            "2283957470012": "افوكادو 500 جرام",
            "2283958160039": "عنب ابيض مستورد 500 جرام",
            "2283958160037": "موز بلدي فاخر 1ك معبأ",
            "2283957840013": "كنتالوب 2ك معبأ",
            "2283958160028": "كزبرة معبأ",
            "2283958160027": "كرفس فرنساوي 250 جرام",
            "2283958160026": "شبت معبأ",
            "2283958160024": "زعتر فريش معبأ",
            "2283958160023": "ريحان اخضر معبأ",
            "2283958160022": "روزمارى فريش معبأ",
            "2283958160021": "جرجير معبأ",
            "2283958160020": "بقدونس معبأ",
            "2283957530013": "مشروم 200 جرام معبأ",
            "2283958140013": "كرنب احمر سلطة معبأ",
            "2283958120015": "كرنب ابيض سلطة معبأ",
            "2283958100017": "كابوتشى معبأ",
            "2283957780012": "زنجبيل 100 جرام معبأ",
            "2283957730017": "ذرة سكري 2 قطعه",
            "2283958160019": "خس بلدي فاخر معبأ",
            "2283958160017": "بصل اخضر معبأ",
            "2283957520014": "ليمون بلدى فاخر معبأ 250 جرام",
            "2283958160011": "ليمون اضاليا 250 جرام",
            "2283958150012": "كوسة معبأ 500 جرام",
            "2283958160016": "كرات 250 جرام",
            "2283958060014": "قرنبيط 500 جرام",
            "2283957950019": "فلفل اخضر حار معبأ 250 جرام",
            "2283958160014": "فجل احمر 500 جرام",
            "2283958160013": "طماطم فاخر معبأ 1ك",
            "2283957850012": "طماطم شيرى معبأ 250 جرام",
            "2283958160012": "خيار فاخر معبأ 1ك",
            "2283957670016": "جزر معبأ 500 جرام",
            "2283957610012": "بنجر احمر معبأ 500 جرام",
            "2283958020018": "بروكلي 500 جرام",
            "2283957940010": "باذنجان عروس اسود معبأ 500 جرام",
            "2283958160074": "عنب اسود 1ك",
            "2283957960018": "باذنجان عروس ابيض معبأ 500 جرام",
            "2283958160015": "فلفل حار احمر 250 جرام",
            "2283958160040": "فراوله 250 جرام",
            "2283958160056": "كمثري لبناني 500 جرام",
            "2283958160062": "حرنكش مقشر 250 جرام",
            "2283957740023": "برقوق اصفر مستورد 1ك",
            "2283958160071": "بلح عراقي 1ك",
            "2283957910070": "بطيخ",
            "2283957910071": "بطيخ احمر بدون بذر",
            "2283957910072": "بطيخ اصفر بدون بذر",
            "2283957910073": "خوخ سكرى",
            "2283957660071": "بسلة 500 جم",
            "2283957660072": "فاصوليا خضراء 500جم",
            "2283958160030": "جريب فروت ابيض 1كجم",
            "2283958160099": "جريب فروت احمر 1كجم",
            "2283957660107": "خوخ محلي 1كجم",
            "2283957660067": "يوسفي كريستينا 1كجم",
            "2283957900014": "شمام شهد 1ك معبأ",
            "": "باذنجان للحشو 350جم",
            "2283958160068": "تفاح مشكل 1كجم"
        }


categories_dict = {
            "اعشاب": [
    "بصل اخضر معبأ",
    "بقدونس معبأ",
    "جرجير معبأ",
    "خس بلدي فاخر معبأ",
    "روزمارى فريش معبأ",
    "ريحان اخضر معبأ",
    "زعتر فريش معبأ",
    "شبت معبأ",
    "كابوتشى معبأ",
    "كرفس فرنساوي 250 جرام",
    "كرنب ابيض سلطة معبأ",
    "كرنب احمر سلطة معبأ",
    "كزبرة معبأ",
    "ملوخية جاهزة500جم",
    "كرات 250 جرام",
],
"جاهز": [
    "باذنجان للحشو 350جم",
    "بسلة مفصصة بالجزر فريش 350 جرام",
    "بسلة مفصصة فريش 350 جرام",
    "بطاطس شرائح 350 جم",
    "بطاطس شيبسى فريش 350 جرام",
    "بطاطس صوابع فريش 350 جرام",
    "جزر مقطع 350 جم",
    "خضار مشكل فريش 350 جرام",
    "رمان مفرط 350 جم",
    "سوتيه فريش 350 جرام",
    "عبوة ثوم مفصص 100 جرام",
    "فاصوليا مقطعة فريش 350 جرام",
    "فلفل مقور محشي 350 جم",
    "قرع مكعبات صافى 350 جرام",
    "قرنبيط 500 جرام",
    "قصب مقشر350جم",
    "قلقاس مكعبات فريش 350 جرام",
    "كابوتشا مقطع 350 جم",
    "كوسة حلقات 350جم",
    "كوسة مقورة فريش 350 جرام",
    "محشى مشكل فريش 350 جرام",
    "ملوخية جاهزة350جم",
    "ميكس كرنب سلطة مقطع فريش 350 جرام",
    "بامية جاهزة 350 جم",
],
"خضار": [
    "باذنجان عروس اسود معبأ 500 جرام",
    "باذنجان كوبى معبأ 1ك",
    "بصل ابيض معبأ 1ك",
    "بصل احمر معبأ 1ك",
    "بطاطا 1ك",
    "بطاطس معبأ 1ك",
    "بنجر احمر معبأ 500 جرام",
    "ثوم صيني ابيض 200جم",
    "جزر معبأ 500 جرام",
    "خيار فاخر معبأ 1ك",
    "طماطم فاخر معبأ 1ك",
    "فجل احمر 500 جرام",
    "فلفل اخضر حار معبأ 250 جرام",
    "فلفل اخضر كوبي 250جم",
    "فلفل الوان معبأ 500 جرام",
    "فلفل حلو 250 جرام",
    "كوسة معبأ 500 جرام",
    "ليمون اضاليا 250 جرام",
    "ليمون بلدى فاخر معبأ 250 جرام",
    "باذنجان عروس ابيض معبأ 500 جرام",
    "بسلة 500 جم",
    "فاصوليا خضراء 500جم",
    "فلفل حار احمر 250 جرام",
],
"فاكهه": [
    "ابوفروة 250جم",
    "افوكادو 500 جرام",
    "اناناس سكري فاخر معبأ",
    "برتقال عصير 2ك معبأ",
    "بروكلي 500 جرام",
    "بطيخ",
    "بطيخ احمر بدون بذر",
    "بطيخ اصفر بدون بذر",
    "تفاح احمر مستورد 1ك معبأ",
    "تفاح اخضر امريكى 1ك معبأ",
    "تفاح اصفر ايطالى 1ك معبأ",
    "تفاح سكرى جالا 1ك معبأ",
    "تفاح مشكل 1كجم",
    "جوز هند قطعة",
    "خوخ سكرى",
    "خوخ محلي 1كجم",
    "ذرة سكري 2 قطعه",
    "زنجبيل 100 جرام معبأ",
    "طماطم شيرى معبأ 250 جرام",
    "عنب اسود 1ك",
    "عنب اسود مستورد 500 جرام معبأ",
    "عنب ايرلي سويت ابيض 1ك",
    "فول سوداني 500جم",
    "كنتالوب 2ك معبأ",
    "كيوي فاخر 250 جرام معبأ",
    "مشروم 200 جرام معبأ",
    "موز بلدي فاخر 1ك معبأ",
    "موز مستورد 1ك",
    "يوسفي بلدي 1كجم",
    "يوسفي موركت 1ك",
    "برتقال بسرة 1ك",
    "برقوق احمر محلي 1ك",
    "برقوق احمر مستورد 1ك",
    "برقوق اصفر مستورد 1ك",
    "بلح برحي 500 جم",
    "بلح عراقي 1ك",
    "جريب فروت ابيض 1كجم",
    "جريب فروت احمر 1كجم",
    "جوافة 1ك معبأ",
    "حرنكش مقشر 250 جرام",
    "خوخ مستورد 500 جم",
    "رمان 1كجم",
    "شمام شهد 1ك معبأ",
    "عنب ابيض مستورد 500 جرام",
    "عنب بناتى 1ك",
    "عنب فليم احمر 1ك",
    "عنب كريمسون لبنانى 500 جرام معبأ",
    "فراوله 250 جرام",
    "كريز 250 جم",
    "كمثرى افريقي500 جرام",
    "كمثري لبناني 500 جرام",
    "مانجو زبدية 1ك",
    "مانجو صديقة 1ك",
    "مانجو عويس 1 ك",
    "مانجو فص عويس 500 جم",
    "مانجو فونس 1 ك",
    "نكتارين مستورد 500 جم",
    "يوسفي كريستينا 1كجم",
    "يوسفي كلمنتينا 1كجم",
]
}



translation_dict = {926242: 'ملوخية جاهزة500جم',
        924881: 'فاصوليا مقطعة فريش 350 جرام',
        924880: 'كابوتشا مقطع 350 جم',
        924879: 'ميكس كرنب سلطة مقطع فريش 350 جرام',
        924878: 'بطاطس شيبسى فريش 350 جرام',
        924877: 'بطاطس صوابع فريش 350 جرام',
        924876: 'فلفل مقور محشي 350 جم',
        924875: 'بطاطس شرائح 350 جم',
        924874: 'جزر مقطع 350 جم',
        924873: 'كوسة حلقات 350جم',
        924871: 'فلفل حلو 250 جرام',
        924868: 'رمان 1كجم',
        924867: 'ابوفروة 250جم',
        924864: 'يوسفي كلمنتينا 1كجم',
        924862: 'يوسفي بلدي 1كجم',
        924861: 'بلح برحي 500 جم',
        924860: 'خوخ مستورد 500 جم',
        924859: 'نكتارين مستورد 500 جم',
        924858: 'فلفل اخضر كوبي 250جم',
        924857: 'ثوم صيني ابيض 200جم',
        924856: 'فول سوداني 500جم',
        913437: 'رمان مفرط 350 جم',
        912855: 'بامية جاهزة 350 جم',
        912854: 'ملوخية جاهزة350جم',
        912852: 'كريز 250 جم',
        912850: 'مانجو فونس 1 ك',
        912849: 'مانجو فص عويس 500 جم',
        912848: 'مانجو عويس 1 ك',
        912847: 'مانجو صديقة 1ك',
        912846: 'مانجو زبدية 1ك',
        912845: 'برقوق احمر محلي 1ك',
        912844: 'عنب بناتى 1ك',
        912843: 'عنب ايرلي سويت ابيض 1ك',
        912842: 'عنب فليم احمر 1ك',
        912841: 'قصب مقشر350جم',
        912840: 'قلقاس مكعبات فريش 350 جرام',
        912839: 'محشى مشكل فريش 350 جرام',
        912838: 'كوسة مقورة فريش 350 جرام',
        912837: 'كمثرى افريقي500 جرام',
        912836: 'فلفل الوان معبأ 500 جرام',
        911211: 'تفاح اصفر ايطالى 1ك معبأ',
        911045: 'برتقال عصير 2ك معبأ',
        911044: 'جوز هند قطعة',
        911043: 'يوسفي موركت 1ك',
        911042: 'جوافة 1ك معبأ',
        911041: 'بطاطا 1ك',
        911040: 'برتقال بسرة 1ك',
        911039: 'بطاطس معبأ 1ك',
        911038: 'بصل احمر معبأ 1ك',
        911037: 'بصل ابيض معبأ 1ك',
        911036: 'باذنجان كوبى معبأ 1ك',
        910161: 'عنب كريمسون لبنانى 500 جرام معبأ',
        910159: 'قرع مكعبات صافى 350 جرام',
        910158: 'عبوة ثوم مفصص 100 جرام',
        910157: 'خضار مشكل فريش 350 جرام',
        910156: 'سوتيه فريش 350 جرام',
        910155: 'بسلة مفصصة بالجزر فريش 350 جرام',
        910154: 'بسلة مفصصة فريش 350 جرام',
        910153: 'عنب اسود مستورد 500 جرام معبأ',
        910152: 'موز مستورد 1ك',
        910151: 'كيوي فاخر 250 جرام معبأ',
        910150: 'تفاح اخضر امريكى 1ك معبأ',
        910149: 'تفاح سكرى جالا 1ك معبأ',
        910148: 'تفاح احمر مستورد 1ك معبأ',
        910147: 'برقوق احمر مستورد 1ك',
        910146: 'اناناس سكري فاخر معبأ',
        910144: 'افوكادو 500 جرام',
        910142: 'عنب ابيض مستورد 500 جرام',
        910141: 'موز بلدي فاخر 1ك معبأ',
        910140: 'كنتالوب 2ك معبأ',
        910139: 'كزبرة معبأ',
        910138: 'كرفس فرنساوي 250 جرام',
        910137: 'شبت معبأ',
        910136: 'زعتر فريش معبأ',
        910135: 'ريحان اخضر معبأ',
        910134: 'روزمارى فريش معبأ',
        910133: 'جرجير معبأ',
        910132: 'بقدونس معبأ',
        910131: 'مشروم 200 جرام معبأ',
        910130: 'كرنب احمر سلطة معبأ',
        910129: 'كرنب ابيض سلطة معبأ',
        910128: 'كابوتشى معبأ',
        910127: 'زنجبيل 100 جرام معبأ',
        910126: 'ذرة سكري 2 قطعه',
        910125: 'خس بلدي فاخر معبأ',
        910124: 'بصل اخضر معبأ',
        910123: 'ليمون بلدى فاخر معبأ 250 جرام',
        910122: 'ليمون اضاليا 250 جرام',
        910121: 'كوسة معبأ 500 جرام',
        910120: 'كرات 250 جرام',
        910119: 'قرنبيط 500 جرام',
        910117: 'فلفل اخضر حار معبأ 250 جرام',
        910116: 'فجل احمر 500 جرام',
        910115: 'طماطم فاخر معبأ 1ك',
        910114: 'طماطم شيرى معبأ 250 جرام',
        910113: 'خيار فاخر معبأ 1ك',
        910112: 'جزر معبأ 500 جرام',
        910111: 'بنجر احمر معبأ 500 جرام',
        910110: 'بروكلي 500 جرام',
        910108: 'باذنجان عروس اسود معبأ 500 جرام',
        912853: 'عنب اسود 1ك',
        910109: 'باذنجان عروس ابيض معبأ 500 جرام',
        910118: 'فلفل حار احمر 250 جرام',
        910143: 'فراوله 250 جرام',
        910145: 'كمثري لبناني 500 جرام',
        910160: 'حرنكش مقشر 250 جرام',
        911046: 'برقوق اصفر مستورد 1ك',
        911047: 'بلح عراقي 1ك',
        911212: 'بطيخ',
        911213: 'بطيخ احمر بدون بذر',
        911214: 'بطيخ اصفر بدون بذر',
        911215: 'خوخ سكرى',
        924865: 'بسلة 500 جم',
        924866: 'فاصوليا خضراء 500جم',
        924869: 'جريب فروت ابيض 1كجم',
        924870: 'جريب فروت احمر 1كجم',
        924872: 'خوخ محلي 1كجم',
        924863: 'يوسفي كريستينا 1كجم',
        912835: 'شمام شهد 1ك معبأ',
        912845: 'برقوق احمر محلي 1ك', 
        912842: 'عنب فليم احمر 1ك'}


columns = [
        "No.", 
        "SKU", 
        "Supplier SKU", 
        "Barcode", 
        "Product", 
        "Qty", 
        "Unit\nCost", 
        "Disc.\nAmt.", 
        "Amt.\nExcl.\nVAT", 
        "VAT\n%", 
        "VAT\nAmt.", 
        "Amt.\nIncl.\nVAT"
    ]
branches_translation_tlbt = {
    "سيدي بشر": "Sidibeshr",
    "الابراهيميه": "ibrahimia",
    "وينجت": "Wenget",
    "المعادي لاسلكي": "Laselkey Maadi",
    "حدائق الاهرام": "Haram Hadayek",
    "الظاهر": "El Daher",
    "المقطم": "MOKATAM",
    "السيدة زينب": "El Sayeda Zeinab",
    "حلوان": "Helwan",
    "المنيل": "El Manel",
    "المقطم 2 هضبة": "El-Hadaba El-Wosta",
    "شبرا": "Shobra",
    "الدقي": "Dokki",
    "زهراء المعادي": "zahra Maadi",
    "ميدان لبنان": "Midan Lubnan",
    "العجوزة": "Agouza",
    "كورنيش المعادي": "kornash Maadi",
    "زهراء المعادي - 2": "zahra Maadi2",
    "اسيوط": "Asyut",
    "هيليوبليس": "Heliopolis",
    "هرم ترسا": "Haram Trsa",
    "اكتوبر": "OCTOBER",
    "سيتي ستارز": "City Stars",
    "فرست مول": "First Mall",
    "فونت مول": "Fount Mall",
    "حدائق القبه": "Hadaeq Al Qubbah",
    "الشيخ زايد": "ZAYED",
    "الرحاب": "Rehab",
    "عين شمس": "AinShams",
    "التجمع الاول": "TAGMOE AWAL",
    "مدينة نصر": "Nasr City",
    "فيصل": "Fesal",
    "حدائق اكتوبر": "Hadayek October",
    "الاسماعيليه": "ismailia",
    "مدينتي كرافت": "Madinaty Craft",
    "مدينتي": "Madinaty",
    "المنصورة جمهورية": "Mansoura Gomhoria",
    "المنصورة": "Mansoura",
    "الحي العاشر": "Nasr City Hay asher",
    "العبور": "Obour",
    "برايت مول": "Bright Mall",
    "بالم هيلز": "Palm Hills",
    "بورسعيد": "portsaid",
    "الرحاب تشيل اوت": "Rehab Chillout",
    "الشروق": "Shrouk",
    "التجمع محكمه": "TAGMOE MAHKMA",
    "التجمع جولدن سكوير": "Golden square",
    "طنطا": "Tanta",
    "الزقازيق": "Zagazig",
    "هيليوبليس شيراتون": "heliopolis sheraton",
    "الشروق 2": "Shrouk 2",
    "زايد 2": "Zayed 2"
}

branches_dict = {
        "EG_Alex East_DS_26": "سيدي بشر",
        "EG_Alex West_DS_27": "الابراهيميه",
        "EG_Alex_Wingat_DS_41": "وينجت",
        "EG_Cairo_DS_1": "المعادي لاسلكي",
        "EG_Cairo_DS_18": "حدائق الاهرام",
        "EG_Cairo_DS_16": "الظاهر",
        "EG_Cairo_DS_6": "المقطم",
        "EG_Cairo_DS_15": "السيدة زينب",
        "EG_Cairo_DS_14": "حلوان",
        "EG_Cairo_DS_13": "المنيل",
        "EG_Mokatam hadaba_DS_46": "المقطم 2 هضبة",
        "EG_Shobra_DS_28": "شبرا",
        "EG_Cairo_DS_2": "الدقي",
        "EG_Cairo_DS_4": "زهراء المعادي",
        "EG_Cairo_DS_5": "ميدان لبنان",
        "EG_Cairo_DS_7": "العجوزة",
        "EG_Cairo_DS_9": "كورنيش المعادي",
        "EG_Zahraa Maadi 2_DS_49": "زهراء المعادي - 2",
        "EG_Assuit_DS_35": "اسيوط",
        "EG_Cairo_DS_10": "هيليوبليس",
        "EG_Cairo_DS_11": "هرم ترسا",
        "EG_Cairo_DS_12": "اكتوبر",
        "EG_Cairo_DS_17": "سيتي ستارز",
        "EG_Cairo_DS_19": "فرست مول",
        "EG_Cairo_DS_20": "فونت مول",
        "EG_Cairo_DS_21": "حدائق القبه",
        "EG_Cairo_DS_22": "الشيخ زايد",
        "EG_Cairo_DS_3": "الرحاب",
        "EG_Cairo_DS_31": "عين شمس",
        "EG_Cairo_DS_37_Tagamoa-Awal": "التجمع الاول",
        "EG_Cairo_DS_8": "مدينة نصر",
        "EG_faisal_DS_42": "فيصل",
        "EG_Hadayek October_DS_44": "حدائق اكتوبر",
        "EG_Ismailia_DS_34": "الاسماعيليه",
        "EG_Madinaty Craft_DS_39": "مدينتي كرافت",
        "EG_Madinaty_DS_23": "مدينتي",
        "EG_Mansoura gomhoreya_DS_48": "المنصورة جمهورية",
        "EG_Mansoura_DS_25": "المنصورة",
        "EG_Nasrcity 10th_DS_40": "الحي العاشر",
        "EG_Obour_DS_30": "العبور",
        "EG_October industrial_DS_47": "برايت مول",
        "EG_Palmhills_DS_36": "بالم هيلز",
        "EG_Portsaid_DS_32": "بورسعيد",
        "EG_Rehab_chillout_DS_50": "الرحاب تشيل اوت",
        "EG_Shrouk_DS_29": "الشروق",
        "EG_Tagamoa 5_Mahkama_DS_43": "التجمع محكمه",
        "EG_Tagamoa Golden Sq_DS_45": "التجمع جولدن سكوير",
        "EG_Tanta_DS_24": "طنطا",
        "EG_Zakazik_DS_33": "الزقازيق",
        "EG_Heliopolis_Sheraton_DS_52": "هيليوبليس شيراتون",
        "EG_Shrouk_ Mgawra (2)_DS_51": "الشروق 2",
        "EG_Sheikh zayed (2)_DS_53": "زايد 2"
    }


special_codes = {
        "EG_Alex East_DS_", "EG_Alex", "EG_Zahraa Maadi", "EG_Nasrcity", "EG_Mansoura", 
        "EG_Tagamoa Golden", "EG_Tagamoa", "EG_Madinaty", "EG_Hadayek", "EG_October", "EG_Shrouk_", "EG_Mokatam", "EG_Sheikh"
    }







import os
import requests
import io
from datetime import datetime
from typing import Optional
from google.oauth2.credentials import Credentials
from google.auth.transport.requests import Request
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build

SUPABASE_URL = "https://rabwvltxgpdyvpmygdtc.supabase.co"
API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhYnd2bHR4Z3BkeXZwbXlnZHRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMzg4MTQsImV4cCI6MjA2NDgxNDgxNH0.hnQYr3jL0rLTNOGXE0EgF9wmd_bynff6JXtqwjCOc6Y"
AUTHORIZATION = f"Bearer {API_KEY}"
STORAGE_BUCKET = "order_files"
TABLE_NAME = "orders"
SCOPES = ['https://www.googleapis.com/auth/gmail.readonly']


def authenticate_gmail():
    creds = None
    if os.path.exists('token.json'):
        creds = Credentials.from_authorized_user_file('token.json', SCOPES)

    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            creds.refresh(Request())
        else:
            flow = InstalledAppFlow.from_client_secrets_file('credentials.json', SCOPES)
            creds = flow.run_local_server(port=0)
        with open('token.json', 'w') as token:
            token.write(creds.to_json())

    return build('gmail', 'v1', credentials=creds)


def upload_order_and_metadata(
    file_bytes: bytes,
    filename: str,
    client: str,
    order_type: str,
    order_date: str,
    delivery_date: str,
    status: str = "Pending",
    city: Optional[str] = None,
    po_number: Optional[int] = None,
):
    object_name = f"{int(order_date.replace('-', ''))}-{filename}"
    storage_url = f"{SUPABASE_URL}/storage/v1/object/{STORAGE_BUCKET}/{object_name}"

    upload_response = requests.post(
        storage_url,
        headers={
            "apikey": API_KEY,
            "authorization": AUTHORIZATION,
            "x-upsert": "false",
        },
        files={
            "file": (filename, file_bytes, "application/zip")
        }
    )

    if upload_response.status_code != 200:
        raise Exception(f"Upload failed: {upload_response.text}")

    file_url = f"{SUPABASE_URL}/storage/v1/object/public/{STORAGE_BUCKET}/{object_name}"
    insert_payload = [{
        "client": client,
        "order_type": order_type,
        "order_date": order_date,
        "delivery_date": delivery_date,
        "status": status,
        "file_urls": [file_url],
        "city": city,
        "po_number": po_number
    }]

    insert_response = requests.post(
        f"{SUPABASE_URL}/rest/v1/{TABLE_NAME}",
        headers={
            "apikey": API_KEY,
            "authorization": AUTHORIZATION,
            "content-type": "application/json",
            "prefer": "return=representation",
        },
        json=insert_payload
    )

    if insert_response.status_code not in [200, 201]:
        raise Exception(f"Insertion failed: {insert_response.text}")

    return insert_response.json()
